## 开始

 - 以vultr centos7 为例
 - 以下所有命令 均在VPS的ssh窗口执行
 - iptables规则比较复杂，不可乱动
 - [视频教程](https://www.youtube.com/watch?v=xIP0kRWWZEA)

### 第一步 安装iptables并启动设置开机自启

```
yum install iptables-services -y  #安装iptables
systemctl start iptables  #启动
systemctl enable iptables  #开机启动
```

### 第二步 写入规则并保存

#### 配合Adguard home 推荐此

- 自行安装好Adguard home并设定了上游DNS为TCP方式(最后面有截图)，不需要修改系统DNS
- 然后执行以下命令

```
#劫持出网访问53端口的所有UDP流量到Adguard home
iptables -t nat -A OUTPUT -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.1
#保存规则
service iptables save 
```

#### 或不使用Adguard home

- DNS 替换成产品面板提供的DNS IP

```
#劫持出网访问53端口的所有UDP流量到指定DNS
iptables -t nat -A OUTPUT -p udp -m udp --dport 53 -j DNAT --to-destination DNS
#保存规则
service iptables save 
```

### 第三步 开放端口并保存规则

```
#下列命令中4代表插入第四行，原行下移，22端口在第四行，注意顺序不要乱，顺序为优先级
iptables -I INPUT 4 -p tcp -m tcp --dport 8080 -j ACCEPT #开启8080 tcp端口
iptables -I INPUT 4 -p udp -m udp --dport 8080 -j ACCEPT  #开启8080 udp端口
#保存规则
service iptables save
```

## 以下可能用到的命令示例

iptables防火墙与其它防火墙不能共存，自行检查是否有其它，有则需要停止并开机禁用

```
yum install iptables-services -y #安装iptables
//常用命令
systemctl status iptables  #状态
systemctl start iptables  #启动
systemctl stop iptables  #禁用
systemctl restart iptables  #重启
systemctl enable iptables  #开机启动
systemctl disable iptables  #开机禁用
service iptables save  #保存规则

#安装后默认规则一般为，小部分不一样，自行辨别
# Generated by iptables-save v1.4.21 on Thu Sep 16 13:00:42 2021
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [262:38242]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Thu Sep 16 13:00:42 2021

#下列命令中4代表插入第四行，原行下移，22端口在第四行，注意顺序不要乱，顺序为优先级
iptables -I INPUT 4 -p tcp -m tcp --dport 8080 -j ACCEPT #开启8080 tcp端口
iptables -I INPUT 4 -p udp -m udp --dport 8080 -j ACCEPT  #开启8080 udp端口

iptables -L -n --line-number  #显示规则和相对应的编号
iptables -D INPUT 4  #删除编号4得规则

#劫持出网端口53的所有UDP流量到 注意内循环
iptables -t nat -A OUTPUT -p udp -m udp --dport 53 -j DNAT --to-destination 127.0.0.1


```

## iptables劫持DNS


```
iptables -t nat -A OUTPUT -p udp -m udp --dport 53 -j DNAT --to-destination DNS
```

以上命令作用是劫持53UDP流量至指定地址，DNS为变量自行替换，可配合Adguard home使用效果更好

### 配合本地adguard home

- adguard home上游DNS必须设置成tcp

如下

依次点击 设置-DNS设置

![](https://www.nicoimg.com/file/nicoimg/tcpdns.png)

```
iptables -t nat -A PREROUTING -p tcp --dport 10121 -j DNAT --to-destination 10.0.0.102:22
iptables -t nat -A PREROUTING -p udp --dport 10121 -j DNAT --to-destination 10.0.0.102:22
iptables -t nat -A POSTROUTING -p tcp -d 10.0.0.102 --dport 22 -j SNAT --to-source 10.0.0.1
iptables -t nat -A POSTROUTING -p udp -d 10.0.0.102 --dport 22 -j SNAT --to-source 10.0.0.1


iptables -t nat -A PREROUTING -p tcp -m tcp --dport 10122:10130 -j DNAT --to-destination 10.0.0.102
iptables -t nat -A PREROUTING -p udp -m udp --dport 10122:10130 -j DNAT --to-destination 10.0.0.102
iptables -t nat -A POSTROUTING -d 10.0.0.102 -p tcp -m tcp --dport 10122:10130 -j SNAT --to-source 10.0.0.1
iptables -t nat -A POSTROUTING -d 10.0.0.102 -p udp -m udp --dport 10122:10130 -j SNAT --to-source 10.0.0.1
```
```
iptables -I INPUT -m state --state NEW -m tcp -p tcp --dport 15000:15004 -j ACCEPT
iptables -I INPUT -m state --state NEW -m udp -p udp --dport 15000:15004 -j ACCEPT
```


 ```
iptables -A OUTPUT -p tcp -m set --match-set whitev4 dst -m hashlimit --hashlimit-name limitDownLink --hashlimit-upto 5000kb/s --hashlimit-mode dstip --hashlimit-burst 6000kb -j ACCEPT
iptables -A OUTPUT -p tcp -m set --match-set whitev4 dst -j DROP
```
