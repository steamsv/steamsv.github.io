## 授权模块


### 第一步 安装iptables并启动设置开机自启

```
yum install iptables-services -y  #安装iptables
systemctl start iptables  #启动
systemctl enable iptables  #开机启动
```



### 第二步 安装ipset并设置开机自启

```
yum install ipset-service
systemctl enable ipset
```

### 第三步 创建ipset合集

```
ipset create -exist whitev4 hash:net family inet hashsize 1024 maxelem 1000000 timeout 0
```

### ipset 持久化

- 修改`/etc/sysconfig/ipset-config` 中的`IPSET_SAVE_ON_STOP="yes"` 设置为YES


### 第五步 白名单规则

端口
```
-A INPUT -p tcp -m set --match-set whitev4 src -m tcp --dport 80 -j ACCEPT
```
ip
```
-A INPUT -s 1.1.1.1/32 -p tcp -m tcp --dport 80 -j ACCEPT
```

### 其它示例

手动添加ip
```
ipset -exist add whitev4 255.255.255.255 timeout 120
```
### 完整模版
```
# Generated by iptables-save v1.8.4 on Sat Jan 29 08:52:06 2022
*security
:INPUT ACCEPT [1916:1119910]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [1975:309855]
COMMIT
# Completed on Sat Jan 29 08:52:06 2022
# Generated by iptables-save v1.8.4 on Sat Jan 29 08:52:06 2022
*raw
:PREROUTING ACCEPT [1919:1120050]
:OUTPUT ACCEPT [1975:309855]
COMMIT
# Completed on Sat Jan 29 08:52:06 2022
# Generated by iptables-save v1.8.4 on Sat Jan 29 08:52:06 2022
*mangle
:PREROUTING ACCEPT [1919:1120050]
:INPUT ACCEPT [1919:1120050]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [1975:309855]
:POSTROUTING ACCEPT [1975:309855]
COMMIT
# Completed on Sat Jan 29 08:52:06 2022
# Generated by iptables-save v1.8.4 on Sat Jan 29 08:52:06 2022
*nat
:PREROUTING ACCEPT [3:140]
:INPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
# Completed on Sat Jan 29 08:52:06 2022
# Generated by iptables-save v1.8.4 on Sat Jan 29 08:52:06 2022
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [33:3488]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m set --match-set whitev4 src -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m set --match-set whitev4 src -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m set --match-set whitev4 src -m tcp --dport 8443 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j DROP
-A INPUT -p tcp -m tcp --dport 443 -j DROP
-A INPUT -p tcp -m tcp --dport 8443 -j DROP
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Sat Jan 29 08:52:06 2022
```
